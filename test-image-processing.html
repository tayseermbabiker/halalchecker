<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Image Processing - HalalDetect</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            max-width: 800px;
        }
        .test-container {
            padding: 20px;
            border: 2px solid #ccc;
            border-radius: 8px;
            margin: 20px 0;
        }
        .upload-area {
            border: 2px dashed #007bff;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            margin: 20px 0;
        }
        .upload-area:hover {
            background-color: #f8f9fa;
        }
        input[type="file"] {
            display: none;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        #preview {
            max-width: 300px;
            max-height: 300px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>HalalDetect - Image Processing Test</h1>
    
    <div class="test-container">
        <h2>Test Image Upload and Processing</h2>
        <p>This page tests the image processing functionality without the full app UI.</p>
        
        <div class="upload-area" onclick="document.getElementById('test-file-input').click()">
            <p>ðŸ“· Click here to select an image</p>
            <p>Supported formats: JPG, PNG, GIF, WebP</p>
        </div>
        
        <input type="file" id="test-file-input" accept="image/*" onchange="handleTestImageUpload(event)">
        
        <img id="preview" style="display: none;" alt="Preview">
        
        <div>
            <button onclick="testBase64Conversion()">Test Base64 Conversion</button>
            <button onclick="testImageProcessing()" id="process-btn" disabled>Test Image Processing</button>
            <button onclick="clearResults()">Clear Results</button>
        </div>
        
        <div id="results"></div>
    </div>

    <script>
        let currentFile = null;
        let currentBase64 = null;
        
        // Test configuration - replace with your OpenAI API key for testing
        const TEST_API_KEY = 'your-openai-api-key-here';
        
        function handleTestImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                currentFile = file;
                
                // Show preview
                const preview = document.getElementById('preview');
                preview.src = URL.createObjectURL(file);
                preview.style.display = 'block';
                
                // Enable processing button
                document.getElementById('process-btn').disabled = false;
                
                showResult(`File selected: ${file.name} (${(file.size / 1024).toFixed(1)} KB, ${file.type})`, 'success');
            }
        }
        
        async function testBase64Conversion() {
            if (!currentFile) {
                showResult('Please select an image first', 'error');
                return;
            }
            
            try {
                currentBase64 = await fileToBase64(currentFile);
                const base64Preview = currentBase64.substring(0, 100) + '...';
                showResult(`Base64 conversion successful. Length: ${currentBase64.length} characters. Preview: ${base64Preview}`, 'success');
            } catch (error) {
                showResult(`Base64 conversion failed: ${error.message}`, 'error');
            }
        }
        
        async function testImageProcessing() {
            if (!currentFile || !currentBase64) {
                showResult('Please select an image and test base64 conversion first', 'error');
                return;
            }
            
            if (TEST_API_KEY === 'your-openai-api-key-here') {
                showResult('Please set your OpenAI API key in the TEST_API_KEY variable to test image processing', 'error');
                return;
            }
            
            try {
                showResult('Processing image...', 'success');
                const ingredients = await extractIngredientsFromImage(currentBase64, currentFile.type);
                showResult(`Image processing successful! Found ingredients: ${ingredients.join(', ')}`, 'success');
            } catch (error) {
                showResult(`Image processing failed: ${error.message}`, 'error');
                console.error('Full error:', error);
            }
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('preview').style.display = 'none';
            document.getElementById('test-file-input').value = '';
            document.getElementById('process-btn').disabled = true;
            currentFile = null;
            currentBase64 = null;
        }
        
        function showResult(message, type) {
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `result ${type}`;
            resultDiv.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            resultsDiv.appendChild(resultDiv);
        }
        
        // Copy the functions from the main app
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
            });
        }
        
        async function extractIngredientsFromImage(base64Image, fileType = 'image/jpeg') {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${TEST_API_KEY}`
                },
                body: JSON.stringify({
                    model: 'gpt-4o',
                    messages: [{
                        role: 'user',
                        content: [
                            {
                                type: 'text',
                                text: `Extract ingredients from this image for halal analysis.

IMPORTANT: Your response must start with "INGREDIENTS:" followed by a comma-separated list of ingredients ONLY. Do not include any other text before the ingredients list.

This image may contain:
1. INGREDIENT LIST - Extract all visible ingredients
2. BARCODE - If you only see a barcode, respond with "INGREDIENTS: BARCODE_DETECTED"
3. PRODUCT PACKAGING - Read any visible ingredient information

Instructions:
- Read text in ANY language (English, Arabic, Spanish, French, Chinese, etc.)
- Extract ONLY the ingredient names, not descriptions or nutritional info
- If you see a barcode only, respond exactly with: "INGREDIENTS: BARCODE_DETECTED"
- If you cannot read any ingredients clearly, respond with: "INGREDIENTS: NO_INGREDIENTS_DETECTED"

Format your response like this:
INGREDIENTS: sugar, salt, wheat flour, vegetable oil, natural flavors

Do not include analysis, explanations, or anything else - just the ingredients list as shown above.`
                            },
                            {
                                type: 'image_url',
                                image_url: {
                                    url: `data:${fileType};base64,${base64Image}`
                                }
                            }
                        ]
                    }],
                    max_tokens: 500
                })
            });

            if (!response.ok) {
                const error = await response.json();
                console.error('OpenAI API Error:', error);
                throw new Error(`OpenAI API Error: ${error.error?.message || response.statusText}`);
            }

            const result = await response.json();
            
            if (!result.choices || !result.choices[0] || !result.choices[0].message) {
                console.error('Invalid OpenAI API response:', result);
                throw new Error('Invalid response from OpenAI API');
            }
            
            const ingredientsText = result.choices[0].message.content;
            
            if (!ingredientsText || ingredientsText.trim() === '') {
                console.error('Empty response from OpenAI API');
                throw new Error('No content in OpenAI API response');
            }
            
            // Parse ingredients from the structured response
            let ingredients = [];
            
            // Look for the INGREDIENTS: prefix
            if (ingredientsText.includes('INGREDIENTS:')) {
                const ingredientsPart = ingredientsText.split('INGREDIENTS:')[1].trim();
                
                // Handle special cases
                if (ingredientsPart === 'BARCODE_DETECTED') {
                    throw new Error('Barcode detected. Please scan the ingredient list on the packaging or enter ingredients manually for accurate halal analysis.');
                }
                
                if (ingredientsPart === 'NO_INGREDIENTS_DETECTED') {
                    throw new Error('No ingredients detected in the image. Please ensure the ingredient list is clearly visible and try again.');
                }
                
                // Parse comma-separated ingredients
                ingredients = ingredientsPart.split(',')
                    .map(i => i.trim())
                    .filter(i => i && i.length > 1 && !i.toLowerCase().includes('ingredients'));
            } else {
                // Fallback: try to extract ingredients from unstructured response
                const lines = ingredientsText.split('\n');
                for (const line of lines) {
                    const trimmedLine = line.trim();
                    if (trimmedLine && trimmedLine.length > 2 && 
                        !trimmedLine.toLowerCase().includes('analysis') && 
                        !trimmedLine.toLowerCase().includes('barcode') &&
                        !trimmedLine.startsWith('I can see') &&
                        !trimmedLine.includes('://')) {
                        
                        if (trimmedLine.includes(',')) {
                            const splitIngredients = trimmedLine.split(',')
                                .map(i => i.trim())
                                .filter(i => i && i.length > 1);
                            ingredients.push(...splitIngredients);
                        } else {
                            ingredients.push(trimmedLine);
                        }
                    }
                }
            }
            
            if (ingredients.length === 0) {
                throw new Error('No ingredients could be extracted from the image. Please ensure the ingredient list is clearly visible.');
            }
            
            // Clean up ingredients (remove numbers, parentheses, etc.)
            ingredients = ingredients.map(ingredient => {
                return ingredient.replace(/^\d+\.?\s*/, '') // Remove leading numbers
                    .replace(/\([^)]*\)/g, '') // Remove content in parentheses
                    .replace(/\s+/g, ' ') // Normalize spaces
                    .trim();
            }).filter(ingredient => ingredient.length > 1);
            
            return ingredients;
        }
    </script>
</body>
</html>